/*! WebUploader 0.1.2 */
(function(n,t){var i={},u=function(n,t){var r,u,i;if(typeof n=="string")return f(n);for(r=[],u=n.length,i=0;i<u;i++)r.push(f(n[i]));return t.apply(null,r)},o=function(n,t,i){arguments.length===2&&(i=t,t=null);u(t||[],function(){s(n,i,arguments)})},s=function(n,t,r){var f={exports:t},e;typeof t=="function"&&(r.length||(r=[u,f.exports,f]),e=t.apply(null,r),e!==undefined&&(f.exports=e));i[n]=f.exports},f=function(t){var r=i[t]||n[t];if(!r)throw new Error("`"+t+"` is undefined");return r},h=function(n){var r,t,f,u,e,o=function(n){return n&&n.charAt(0).toUpperCase()+n.substr(1)};for(r in i)if(t=n,i.hasOwnProperty(r)){for(f=r.split("/"),e=o(f.pop());u=o(f.shift());)t[u]=t[u]||{},t=t[u];t[e]=i[r]}},r=t(n,o,u),e;h(r);typeof module=="object"&&typeof module.exports=="object"?module.exports=r:typeof define=="function"&&define.amd?define([],r):(e=n.WebUploader,n.WebUploader=r,n.WebUploader.noConflict=function(){n.WebUploader=e})})(this,function(n,t,i){return t("dollar-third",[],function(){return n.jQuery||n.Zepto}),t("dollar",["dollar-third"],function(n){return n}),t("promise-third",["dollar"],function(n){return{Deferred:n.Deferred,when:n.when,isPromise:function(n){return n&&typeof n.then=="function"}}}),t("promise",["promise-third"],function(n){return n}),t("base",["dollar","promise"],function(t,i){function e(n){return function(){return f.apply(n,arguments)}}function u(n,t){return function(){return n.apply(t,arguments)}}function o(n){var t;return Object.create?Object.create(n):(t=function(){},t.prototype=n,new t)}var r=function(){},f=Function.call;return{version:"0.1.2",$:t,Deferred:i.Deferred,isPromise:i.isPromise,when:i.when,browser:function(n){var t={},i=n.match(/WebKit\/([\d.]+)/),r=n.match(/Chrome\/([\d.]+)/)||n.match(/CriOS\/([\d.]+)/),u=n.match(/MSIE\s([\d\.]+)/)||n.match(/(?:trident)(?:.*rv:([\w.]+))?/i),f=n.match(/Firefox\/([\d.]+)/),e=n.match(/Safari\/([\d.]+)/),o=n.match(/OPR\/([\d.]+)/);return i&&(t.webkit=parseFloat(i[1])),r&&(t.chrome=parseFloat(r[1])),u&&(t.ie=parseFloat(u[1])),f&&(t.firefox=parseFloat(f[1])),e&&(t.safari=parseFloat(e[1])),o&&(t.opera=parseFloat(o[1])),t}(navigator.userAgent),os:function(n){var t={},i=n.match(/(?:Android);?[\s\/]+([\d.]+)?/),r=n.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);return i&&(t.android=parseFloat(i[1])),r&&(t.ios=parseFloat(r[1].replace(/_/g,"."))),t}(navigator.userAgent),inherits:function(n,i,r){var u;return typeof i=="function"?(u=i,i=null):u=i&&i.hasOwnProperty("constructor")?i.constructor:function(){return n.apply(this,arguments)},t.extend(!0,u,n,r||{}),u.__super__=n.prototype,u.prototype=o(n.prototype),i&&t.extend(!0,u.prototype,i),u},noop:r,bindFn:u,log:function(){return n.console?u(console.log,console):r}(),nextTick:function(){return function(n){setTimeout(n,1)}}(),slice:e([].slice),guid:function(){var n=0;return function(t){for(var i=(+new Date).toString(32),r=0;r<5;r++)i+=Math.floor(Math.random()*65535).toString(32);return(t||"wu_")+i+(n++).toString(32)}}(),formatSize:function(n,t,i){var r;for(i=i||["B","K","M","G","TB"];(r=i.shift())&&n>1024;)n=n/1024;return(r==="B"?n:n.toFixed(t||2))+r}}}),t("mediator",["base"],function(n){function r(n,i,r,u){return t.grep(n,function(n){return n&&(!i||n.e===i)&&(!r||n.cb===r||n.cb._cb===r)&&(!u||n.ctx===u)})}function u(n,i,r){t.each((n||"").split(o),function(n,t){r(t,i)})}function f(n,t){for(var r=!1,u=-1,f=n.length,i;++u<f;)if(i=n[u],i.cb.apply(i.ctx2,t)===!1){r=!0;break}return!r}var t=n.$,e=[].slice,o=/\s+/,i;return i={on:function(n,t,i){var f=this,r;return t?(r=this._events||(this._events=[]),u(n,t,function(n,t){var u={e:n};u.cb=t;u.ctx=i;u.ctx2=i||f;u.id=r.length;r.push(u)}),this):this},once:function(n,t,i){var r=this;return t?(u(n,t,function(n,t){var u=function(){return r.off(n,u),t.apply(i||r,arguments)};u._cb=t;r.on(n,u,i)}),r):r},off:function(n,i,f){var e=this._events;return e?!n&&!i&&!f?(this._events=[],this):(u(n,i,function(n,i){t.each(r(e,n,i,f),function(){delete e[this.id]})}),this):this},trigger:function(n){var t,i,u;return!this._events||!n?this:(t=e.call(arguments,1),i=r(this._events,n),u=r(this._events,"all"),f(i,t)&&f(u,arguments))}},t.extend({installTo:function(n){return t.extend(n,i)}},i)}),t("uploader",["base","mediator"],function(n,t){function i(n){this.options=r.extend(!0,{},i.options,n);this._init(this.options)}var r=n.$;return i.options={},t.installTo(i.prototype),r.each({upload:"start-upload",stop:"stop-upload",getFile:"get-file",getFiles:"get-files",addFile:"add-file",addFiles:"add-file",sort:"sort-files",removeFile:"remove-file",skipFile:"skip-file",retry:"retry",isInProgress:"is-in-progress",makeThumb:"make-thumb",getDimension:"get-dimension",addButton:"add-btn",getRuntimeType:"get-runtime-type",refresh:"refresh",disable:"disable",enable:"enable",reset:"reset"},function(n,t){i.prototype[n]=function(){return this.request(t,arguments)}}),r.extend(i.prototype,{state:"pending",_init:function(n){var t=this;t.request("init",n,function(){t.state="ready";t.trigger("ready")})},option:function(n,t){var i=this.options;if(arguments.length>1)r.isPlainObject(t)&&r.isPlainObject(i[n])?r.extend(i[n],t):i[n]=t;else return n?i[n]:i},getStats:function(){var n=this.request("get-stats");return{successNum:n.numOfSuccess,cancelNum:n.numOfCancel,invalidNum:n.numOfInvalid,uploadFailNum:n.numOfUploadFailed,queueNum:n.numOfQueue}},trigger:function(n){var u=[].slice.call(arguments,1),f=this.options,i="on"+n.substring(0,1).toUpperCase()+n.substring(1);return t.trigger.apply(this,arguments)===!1||r.isFunction(f[i])&&f[i].apply(this,u)===!1||r.isFunction(this[i])&&this[i].apply(this,u)===!1||t.trigger.apply(t,[this,n].concat(u))===!1?!1:!0},request:n.noop}),n.create=i.create=function(n){return new i(n)},n.Uploader=i,i}),t("runtime/runtime",["base","mediator"],function(n,t){function i(t){this.options=u.extend({container:document.body},t);this.uid=n.guid("rt_")}var u=n.$,r={},f=function(n){for(var t in n)if(n.hasOwnProperty(t))return t;return null};return u.extend(i.prototype,{getContainer:function(){var i=this.options,t,n;return this._container?this._container:(t=u(i.container||document.body),n=u(document.createElement("div")),n.attr("id","rt_"+this.uid),n.css({position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"}),t.append(n),t.addClass("webuploader-container"),this._container=n,n)},init:n.noop,exec:n.noop,destroy:function(){this._container&&this._container.parentNode.removeChild(this.__container);this.off()}}),i.orders="html5,flash",i.addRuntime=function(n,t){r[n]=t},i.hasRuntime=function(n){return!!(n?r[n]:f(r))},i.create=function(n,t){var e;if(t=t||i.orders,u.each(t.split(/\s*,\s*/g),function(){if(r[this])return e=this,!1}),e=e||f(r),!e)throw new Error("Runtime Error");return new r[e](n)},t.installTo(i.prototype),i}),t("runtime/client",["base","mediator","runtime/runtime"],function(n,t,i){function u(t,u){var e=n.Deferred(),f;this.uid=n.guid("client_");this.runtimeReady=function(n){return e.done(n)};this.connectRuntime=function(t,o){if(f)throw new Error("already connected!");if(e.done(o),typeof t=="string"&&r.get(t)&&(f=r.get(t)),f=f||r.get(null,u),f)n.$.extend(f.options,t),f.__promise.then(e.resolve),f.__client++;else{f=i.create(t,t.runtimeOrder);f.__promise=e.promise();f.once("ready",e.resolve);f.init();r.add(f);f.__client=1}return u&&(f.__standalone=u),f};this.getRuntime=function(){return f};this.disconnectRuntime=function(){f&&(f.__client--,f.__client<=0&&(r.remove(f),delete f.__promise,f.destroy()),f=null)};this.exec=function(){if(f){var i=n.slice(arguments);return t&&i.unshift(t),f.exec.apply(this,i)}};this.getRuid=function(){return f&&f.uid};this.destroy=function(n){return function(){n&&n.apply(this,arguments);this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()}}(this.destroy)}var r;return r=function(){var n={};return{add:function(t){n[t.uid]=t},get:function(t,i){var r;if(t)return n[t];for(r in n)if(!i||!n[r].__standalone)return n[r];return null},remove:function(t){delete n[t.uid]}}}(),t.installTo(u.prototype),u}),t("lib/blob",["base","runtime/client"],function(n,t){function i(n,i){var r=this;r.source=i;r.ruid=n;t.call(r,"Blob");this.uid=i.uid||this.uid;this.type=i.type||"";this.size=i.size||0;n&&r.connectRuntime(n)}return n.inherits(t,{constructor:i,slice:function(n,t){return this.exec("slice",n,t)},getSource:function(){return this.source}}),i}),t("lib/file",["base","lib/blob"],function(n,t){function u(n,u){var f;t.apply(this,arguments);this.name=u.name||"untitled"+i++;f=r.exec(u.name)?RegExp.$1.toLowerCase():"";!f&&this.type&&(f=/\/(jpg|jpeg|png|gif|bmp)$/i.exec(this.type)?RegExp.$1.toLowerCase():"",this.name+="."+f);!this.type&&~"jpg,jpeg,png,gif,bmp".indexOf(f)&&(this.type="image/"+(f==="jpg"?"jpeg":f));this.ext=f;this.lastModifiedDate=u.lastModifiedDate||(new Date).toLocaleString()}var i=1,r=/\.([^.]+)$/;return n.inherits(t,u)}),t("lib/filepicker",["base","runtime/client","lib/file"],function(t,i,r){function f(n){if(n=this.options=u.extend({},f.options,n),n.container=u(n.id),!n.container.length)throw new Error("按钮指定错误");n.innerHTML=n.innerHTML||n.label||n.container.html()||"";n.button=u(n.button||document.createElement("div"));n.button.html(n.innerHTML);n.container.html(n.button);i.call(this,"FilePicker",!0)}var u=t.$;return f.options={button:null,container:null,label:null,innerHTML:null,multiple:!0,accept:null,name:"file"},t.inherits(i,{constructor:f,init:function(){var t=this,i=t.options,f=i.button;f.addClass("webuploader-pick");t.on("all",function(n){var e;switch(n){case"mouseenter":f.addClass("webuploader-pick-hover");break;case"mouseleave":f.removeClass("webuploader-pick-hover");break;case"change":e=t.exec("getFiles");t.trigger("select",u.map(e,function(n){return n=new r(t.getRuid(),n),n._refer=i.container,n}),i.container)}});t.connectRuntime(i,function(){t.refresh();t.exec("init",i);t.trigger("ready")});u(n).on("resize",function(){t.refresh()})},refresh:function(){var r=this.getRuntime().getContainer(),n=this.options.button,t=n.outerWidth?n.outerWidth():n.width(),i=n.outerHeight?n.outerHeight():n.height(),u=n.offset();t&&i&&r.css({bottom:"auto",right:"auto",width:t+"px",height:i+"px"}).offset(u)},enable:function(){var n=this.options.button;n.removeClass("webuploader-pick-disable");this.refresh()},disable:function(){var n=this.options.button;this.getRuntime().getContainer().css({top:"-99999px"});n.addClass("webuploader-pick-disable")},destroy:function(){this.runtime&&(this.exec("destroy"),this.disconnectRuntime())}}),f}),t("widgets/widget",["base","uploader"],function(n,t){function o(n){if(!n)return!1;var t=n.length,r=i.type(n);return n.nodeType===1&&t?!0:r==="array"||r!=="function"&&r!=="string"&&(t===0||typeof t=="number"&&t>0&&t-1 in n)}function r(n){this.owner=n;this.options=n.options}var i=n.$,e=t.prototype._init,u={},f=[];return i.extend(r.prototype,{init:n.noop,invoke:function(n,t){var r=this.responseMap;return!r||!(n in r)||!(r[n]in this)||!i.isFunction(this[r[n]])?u:this[r[n]].apply(this,t)},request:function(){return this.owner.request.apply(this.owner,arguments)}}),i.extend(t.prototype,{_init:function(){var n=this,t=n._widgets=[];return i.each(f,function(i,r){t.push(new r(n))}),e.apply(n,arguments)},request:function(t,i,r){var e=0,l=this._widgets,y=l.length,a=[],s=[],v,f,h,c;for(i=o(i)?i:[i];e<y;e++)v=l[e],f=v.invoke(t,i),f!==u&&(n.isPromise(f)?s.push(f):a.push(f));return r||s.length?(h=n.when.apply(n,s),c=h.pipe?"pipe":"then",h[c](function(){var t=n.Deferred(),i=arguments;return setTimeout(function(){t.resolve.apply(t,i)},1),t.promise()})[c](r||n.noop)):a[0]}}),t.register=r.register=function(t,u){var o={init:"init"},e;return arguments.length===1?(u=t,u.responseMap=o):u.responseMap=i.extend(o,t),e=n.inherits(r,u),f.push(e),e},r}),t("widgets/filepicker",["base","uploader","lib/filepicker","widgets/widget"],function(n,t,i){var r=n.$;return r.extend(t.options,{pick:null,accept:null}),t.register({"add-btn":"addButton",refresh:"refresh",disable:"disable",enable:"enable"},{init:function(n){return this.pickers=[],n.pick&&this.addButton(n.pick)},refresh:function(){r.each(this.pickers,function(){this.refresh()})},addButton:function(t){var s=this,f=s.options,e=f.accept,h,u,o;if(t){o=n.Deferred();r.isPlainObject(t)||(t={id:t});h=r.extend({},t,{accept:r.isPlainObject(e)?[e]:e,swf:f.swf,runtimeOrder:f.runtimeOrder});u=new i(h);u.once("ready",o.resolve);u.on("select",function(n){s.owner.request("add-file",[n])});return u.init(),this.pickers.push(u),o.promise()}},disable:function(){r.each(this.pickers,function(){this.disable()})},enable:function(){r.each(this.pickers,function(){this.enable()})}})}),t("lib/image",["base","runtime/client","lib/blob"],function(n,t,i){function r(n){this.options=u.extend({},r.options,n);t.call(this,"Image");this.on("load",function(){this._info=this.exec("info");this._meta=this.exec("meta")})}var u=n.$;return r.options={quality:90,crop:!1,preserveHeaders:!0,allowMagnify:!0},n.inherits(t,{constructor:r,info:function(n){return n?(this._info=n,this):this._info},meta:function(n){return n?(this._meta=n,this):this._meta},loadFromBlob:function(n){var t=this,i=n.getRuid();this.connectRuntime(i,function(){t.exec("init",t.options);t.exec("loadFromBlob",n)})},resize:function(){var t=n.slice(arguments);return this.exec.apply(this,["resize"].concat(t))},getAsDataUrl:function(n){return this.exec("getAsDataUrl",n)},getAsBlob:function(n){var t=this.exec("getAsBlob",n);return new i(this.getRuid(),t)}}),r}),t("widgets/image",["base","uploader","lib/image","widgets/widget"],function(n,t,i){var r=n.$,u;return u=function(n){var t=0,i=[],r=function(){for(var r;i.length&&t<n;)r=i.shift(),t+=r[0],r[1]()};return function(n,u,f){i.push([u,f]);n.once("destroy",function(){t-=u;setTimeout(r,1)});setTimeout(r,1)}}(5242880),r.extend(t.options,{thumb:{width:110,height:110,quality:70,allowMagnify:!0,crop:!0,preserveHeaders:!1,type:"image/jpeg"},compress:{width:1600,height:1600,quality:90,allowMagnify:!1,crop:!1,preserveHeaders:!0}}),t.register({"make-thumb":"makeThumb","before-send-file":"compressImage"},{makeThumb:function(n,t,f,e){var s,o;if(n=this.request("get-file",n),!n.type.match(/^image/)){t(!0);return}s=r.extend({},this.options.thumb);r.isPlainObject(f)&&(s=r.extend(s,f),f=null);f=f||s.width;e=e||s.height;o=new i(s);o.once("load",function(){n._info=n._info||o.info();n._meta=n._meta||o.meta();o.resize(f,e)});o.once("complete",function(){t(!1,o.getAsDataUrl(s.type));o.destroy()});o.once("error",function(){t(!0);o.destroy()});u(o,n.source.size,function(){n._info&&o.info(n._info);n._meta&&o.meta(n._meta);o.loadFromBlob(n.source)})},compressImage:function(t){var f=this.options.compress||this.options.resize,o=f&&f.compressSize||307200,u,e;if(t=this.request("get-file",t),f&&~"image/jpeg,image/jpg".indexOf(t.type)&&!(t.size<o)&&!t._compressed){f=r.extend({},f);e=n.Deferred();u=new i(f);e.always(function(){u.destroy();u=null});u.once("error",e.reject);u.once("load",function(){t._info=t._info||u.info();t._meta=t._meta||u.meta();u.resize(f.width,f.height)});u.once("complete",function(){var n,i;try{n=u.getAsBlob(f.type);i=t.size;n.size<i&&(t.source=n,t.size=n.size,t.trigger("resize",n.size,i));t._compressed=!0;e.resolve()}catch(r){e.resolve()}});return t._info&&u.info(t._info),t._meta&&u.meta(t._meta),u.loadFromBlob(t.source),e.promise()}}})}),t("file",["base","mediator"],function(n,t){function s(){return f+e++}function i(n){this.name=n.name||"Untitled";this.size=n.size||0;this.type=n.type||"application";this.lastModifiedDate=n.lastModifiedDate||new Date*1;this.id=s();this.ext=o.exec(this.name)?RegExp.$1:"";this.statusText="";r[this.id]=i.Status.INITED;this.source=n;this.loaded=0;this.on("error",function(n){this.setStatus(i.Status.ERROR,n)})}var u=n.$,f="WU_FILE_",e=0,o=/\.([^.]+)$/,r={};return u.extend(i.prototype,{setStatus:function(n,t){var i=r[this.id];typeof t!="undefined"&&(this.statusText=t);n!==i&&(r[this.id]=n,this.trigger("statuschange",n,i))},getStatus:function(){return r[this.id]},getSource:function(){return this.source},destory:function(){delete r[this.id]}}),t.installTo(i.prototype),i.Status={INITED:"inited",QUEUED:"queued",PROGRESS:"progress",ERROR:"error",COMPLETE:"complete",CANCELLED:"cancelled",INTERRUPT:"interrupt",INVALID:"invalid"},i}),t("queue",["base","mediator","file"],function(n,t,i){function u(){this.stats={numOfQueue:0,numOfSuccess:0,numOfCancel:0,numOfProgress:0,numOfUploadFailed:0,numOfInvalid:0};this._queue=[];this._map={}}var f=n.$,r=i.Status;return f.extend(u.prototype,{append:function(n){return this._queue.push(n),this._fileAdded(n),this},prepend:function(n){return this._queue.unshift(n),this._fileAdded(n),this},getFile:function(n){return typeof n!="string"?n:this._map[n]},fetch:function(n){var u=this._queue.length,t,i;for(n=n||r.QUEUED,t=0;t<u;t++)if(i=this._queue[t],n===i.getStatus())return i;return null},sort:function(n){typeof n=="function"&&this._queue.sort(n)},getFiles:function(){for(var i=[].slice.call(arguments,0),r=[],n=0,u=this._queue.length,t;n<u;n++)(t=this._queue[n],!i.length||~f.inArray(t.getStatus(),i))&&r.push(t);return r},_fileAdded:function(n){var t=this,i=this._map[n.id];if(!i){this._map[n.id]=n;n.on("statuschange",function(n,i){t._onFileStatusChange(n,i)})}n.setStatus(r.QUEUED)},_onFileStatusChange:function(n,t){var i=this.stats;switch(t){case r.PROGRESS:i.numOfProgress--;break;case r.QUEUED:i.numOfQueue--;break;case r.ERROR:i.numOfUploadFailed--;break;case r.INVALID:i.numOfInvalid--}switch(n){case r.QUEUED:i.numOfQueue++;break;case r.PROGRESS:i.numOfProgress++;break;case r.ERROR:i.numOfUploadFailed++;break;case r.COMPLETE:i.numOfSuccess++;break;case r.CANCELLED:i.numOfCancel++;break;case r.INVALID:i.numOfInvalid++}}}),t.installTo(u.prototype),u}),t("widgets/queue",["base","uploader","queue","file","lib/file","runtime/client","widgets/widget"],function(n,t,i,r,u,f){var o=n.$,s=/\.\w+$/,e=r.Status;return t.register({"sort-files":"sortFiles","add-file":"addFiles","get-file":"getFile","fetch-file":"fetchFile","get-stats":"getStats","get-files":"getFiles","remove-file":"removeFile",retry:"retry",reset:"reset","accept-file":"acceptFile"},{init:function(t){var r=this,s,l,u,h,e,a,c;if(o.isPlainObject(t.accept)&&(t.accept=[t.accept]),t.accept){for(e=[],u=0,l=t.accept.length;u<l;u++)h=t.accept[u].extensions,h&&e.push(h);e.length&&(a="\\."+e.join(",").replace(/,/g,"$|\\.").replace(/\*/g,".*")+"$");r.accept=new RegExp(a,"i")}if(r.queue=new i,r.stats=r.queue.stats,this.request("predict-runtime-type")==="html5")return s=n.Deferred(),c=new f("Placeholder"),c.connectRuntime({runtimeOrder:"html5"},function(){r._ruid=c.getRuid();s.resolve()}),s.promise()},_wrapFile:function(n){if(!(n instanceof r)){if(!(n instanceof u)){if(!this._ruid)throw new Error("Can't add external files.");n=new u(this._ruid,n)}n=new r(n)}return n},acceptFile:function(n){var t=!n||n.size<6||this.accept&&s.exec(n.name)&&!this.accept.test(n.name);return!t},_addFile:function(n){var t=this;if(n=t._wrapFile(n),t.owner.trigger("beforeFileQueued",n)){if(!t.acceptFile(n)){t.owner.trigger("error","Q_TYPE_DENIED",n);return}return t.queue.append(n),t.owner.trigger("fileQueued",n),n}},getFile:function(n){return this.queue.getFile(n)},addFiles:function(n){var t=this;n.length||(n=[n]);n=o.map(n,function(n){return t._addFile(n)});t.owner.trigger("filesQueued",n);t.options.auto&&t.request("start-upload")},getStats:function(){return this.stats},removeFile:function(n){var t=this;n=n.id?n:t.queue.getFile(n);n.setStatus(e.CANCELLED);t.owner.trigger("fileDequeued",n)},getFiles:function(){return this.queue.getFiles.apply(this.queue,arguments)},fetchFile:function(){return this.queue.fetch.apply(this.queue,arguments)},retry:function(n,t){var i=this,u,r,f;if(n){n=n.id?n:i.queue.getFile(n);n.setStatus(e.QUEUED);t||i.request("start-upload");return}for(u=i.queue.getFiles(e.ERROR),r=0,f=u.length;r<f;r++)n=u[r],n.setStatus(e.QUEUED);i.request("start-upload")},sortFiles:function(){return this.queue.sort.apply(this.queue,arguments)},reset:function(){this.queue=new i;this.stats=this.queue.stats}})}),t("widgets/runtime",["uploader","runtime/runtime","widgets/widget"],function(n,t){return n.support=function(){return t.hasRuntime.apply(t,arguments)},n.register({"predict-runtime-type":"predictRuntmeType"},{init:function(){if(!this.predictRuntmeType())throw Error("Runtime Error");},predictRuntmeType:function(){var n=this.options.runtimeOrder||t.orders,r=this.type,i,u;if(!r)for(n=n.split(/\s*,\s*/g),i=0,u=n.length;i<u;i++)if(t.hasRuntime(n[i])){this.type=r=n[i];break}return r}})}),t("lib/transport",["base","runtime/client","mediator"],function(n,t,i){function r(n){var i=this;n=i.options=u.extend(!0,{},r.options,n||{});t.call(this,"Transport");this._blob=null;this._formData=n.formData||{};this._headers=n.headers||{};this.on("progress",this._timeout);this.on("load error",function(){i.trigger("progress",1);clearTimeout(i._timer)})}var u=n.$;return r.options={server:"",method:"POST",withCredentials:!1,fileVal:"file",timeout:12e4,formData:{},headers:{},sendAsBinary:!1},u.extend(r.prototype,{appendBlob:function(n,t,i){var r=this,u=r.options;r.getRuid()&&r.disconnectRuntime();r.connectRuntime(t.ruid,function(){r.exec("init")});r._blob=t;u.fileVal=n||u.fileVal;u.filename=i||u.filename},append:function(n,t){typeof n=="object"?u.extend(this._formData,n):this._formData[n]=t},setRequestHeader:function(n,t){typeof n=="object"?u.extend(this._headers,n):this._headers[n]=t},send:function(n){this.exec("send",n);this._timeout()},abort:function(){return clearTimeout(this._timer),this.exec("abort")},destroy:function(){this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()},getResponse:function(){return this.exec("getResponse")},getResponseAsJson:function(){return this.exec("getResponseAsJson")},getStatus:function(){return this.exec("getStatus")},_timeout:function(){var n=this,t=n.options.timeout;t&&(clearTimeout(n._timer),n._timer=setTimeout(function(){n.abort();n.trigger("error","timeout")},t))}}),i.installTo(r.prototype),r}),t("widgets/upload",["base","uploader","file","lib/transport","widgets/widget"],function(n,t,i,r){function o(n,t){for(var i=[],s=n.source,r=s.size,e=t?Math.ceil(r/t):1,u=0,o=0,f;o<e;)f=Math.min(t,r-u),i.push({file:n,start:u,end:t?u+f:r,total:r,chunks:e,chunk:o++}),u+=f;return n.blocks=i.concat(),n.remaning=i.length,{file:n,has:function(){return!!i.length},fetch:function(){return i.shift()}}}var f=n.$,e=n.isPromise,u=i.Status;f.extend(t.options,{prepareNextFile:!1,chunked:!1,chunkSize:5242880,chunkRetry:2,threads:3,formData:null});t.register({"start-upload":"start","stop-upload":"stop","skip-file":"skipFile","is-in-progress":"isInProgress"},{init:function(){var t=this.owner;this.runing=!1;this.pool=[];this.pending=[];this.remaning=0;this.__tick=n.bindFn(this._tick,this);t.on("uploadComplete",function(n){n.blocks&&f.each(n.blocks,function(n,t){t.transport&&(t.transport.abort(),t.transport.destroy());delete t.transport});delete n.blocks;delete n.remaning})},start:function(){var t=this;(f.each(t.request("get-files",u.INVALID),function(){t.request("remove-file",this)}),t.runing)||(t.runing=!0,f.each(t.pool,function(n,i){var r=i.file;r.getStatus()===u.INTERRUPT&&(r.setStatus(u.PROGRESS),t._trigged=!1,i.transport&&i.transport.send())}),t._trigged=!1,t.owner.trigger("startUpload"),n.nextTick(t.__tick))},stop:function(n){var t=this;t.runing!==!1&&(t.runing=!1,n&&f.each(t.pool,function(n,t){t.transport&&t.transport.abort();t.file.setStatus(u.INTERRUPT)}),t.owner.trigger("stopUpload"))},isInProgress:function(){return!!this.runing},getStats:function(){return this.request("get-stats")},skipFile:function(n,t){n=this.request("get-file",n);n.setStatus(t||u.COMPLETE);n.skipped=!0;n.blocks&&f.each(n.blocks,function(n,t){var i=t.transport;i&&(i.abort(),i.destroy(),delete t.transport)});this.owner.trigger("uploadSkip",n)},_tick:function(){var t=this,u=t.options,r,i;if(t._promise)return t._promise.always(t.__tick);t.pool.length<u.threads&&(i=t._nextBlock())?(t._trigged=!1,r=function(i){t._promise=null;i&&i.file&&t._startSend(i);n.nextTick(t.__tick)},t._promise=e(i)?i.always(r):r(i)):t.remaning||t.getStats().numOfQueue||(t.runing=!1,t._trigged||n.nextTick(function(){t.owner.trigger("uploadFinished")}),t._trigged=!0)},_nextBlock:function(){var n=this,t=n._act,r=n.options,i,f;return t&&t.has()&&t.file.getStatus()===u.PROGRESS?(r.prepareNextFile&&!n.pending.length&&n._prepareNextFile(),t.fetch()):n.runing?(!n.pending.length&&n.getStats().numOfQueue&&n._prepareNextFile(),i=n.pending.shift(),f=function(i){return i?(t=o(i,r.chunked?r.chunkSize:0),n._act=t,t.fetch()):null},e(i)?i[i.pipe?"pipe":"then"](f):f(i)):void 0},_prepareNextFile:function(){var t=this,n=t.request("fetch-file"),r=t.pending,i;n&&(i=t.request("before-send-file",n,function(){return n.getStatus()===u.QUEUED?(t.owner.trigger("uploadStart",n),n.setStatus(u.PROGRESS),n):t._finishFile(n)}),i.done(function(){var t=f.inArray(i,r);~t&&r.splice(t,1,n)}),i.fail(function(i){n.setStatus(u.ERROR,i);t.owner.trigger("uploadError",n,i);t.owner.trigger("uploadComplete",n)}),r.push(i))},_popBlock:function(n){var t=f.inArray(n,this.pool);this.pool.splice(t,1);n.file.remaning--;this.remaning--},_startSend:function(t){var i=this,r=t.file,f;i.pool.push(t);i.remaning++;t.blob=t.chunks===1?r.source:r.source.slice(t.start,t.end);f=i.request("before-send",t,function(){r.getStatus()===u.PROGRESS?i._doSend(t):(i._popBlock(t),n.nextTick(i.__tick))});f.fail(function(){r.remaning===1?i._finishFile(r).always(function(){t.percentage=1;i._popBlock(t);i.owner.trigger("uploadComplete",r);n.nextTick(i.__tick)}):(t.percentage=1,i._popBlock(t),n.nextTick(i.__tick))})},_doSend:function(t){var o=this,s=o.owner,h=o.options,i=t.file,e=new r(h),c=f.extend({},h.formData),v=f.extend({},h.headers),a,l;t.transport=e;e.on("destroy",function(){delete t.transport;o._popBlock(t);n.nextTick(o.__tick)});e.on("progress",function(n){var r=0,u=0;r=t.percentage=n;t.chunks>1&&(f.each(i.blocks,function(n,t){u+=(t.percentage||0)*(t.end-t.start)}),r=u/i.size);s.trigger("uploadProgress",i,r||0)});a=function(n){var i;return l=e.getResponseAsJson()||{},l._raw=e.getResponse(),i=function(t){n=t},s.trigger("uploadAccept",t,l,i)||(n=n||"server"),n};e.on("error",function(n,r){t.retried=t.retried||0;t.chunks>1&&~"http,abort".indexOf(n)&&t.retried<h.chunkRetry?(t.retried++,e.send()):(r||n!=="server"||(n=a(n)),i.setStatus(u.ERROR,n),s.trigger("uploadError",i,n),s.trigger("uploadComplete",i))});e.on("load",function(){var n;if(n=a()){e.trigger("error",n,!0);return}i.remaning===1?o._finishFile(i,l):e.destroy()});c=f.extend(c,{id:i.id,name:i.name,type:i.type,lastModifiedDate:i.lastModifiedDate,size:i.size});t.chunks>1&&f.extend(c,{chunks:t.chunks,chunk:t.chunk});s.trigger("uploadBeforeSend",t,c,v);e.appendBlob(h.fileVal,t.blob,i.name);e.append(c);e.setRequestHeader(v);e.send()},_finishFile:function(n,t,i){var r=this.owner;return r.request("after-send-file",arguments,function(){n.setStatus(u.COMPLETE);r.trigger("uploadSuccess",n,t,i)}).fail(function(t){n.getStatus()===u.PROGRESS&&n.setStatus(u.ERROR,t);r.trigger("uploadError",n,t)}).always(function(){r.trigger("uploadComplete",n)})}})}),t("widgets/validator",["base","uploader","file","widgets/widget"],function(n,t,i){var f=n.$,u={},r;return r={addValidator:function(n,t){u[n]=t},removeValidator:function(n){delete u[n]}},t.register({init:function(){var n=this;f.each(u,function(){this.call(n.owner)})}}),r.addValidator("fileNumLimit",function(){var n=this,u=n.options,t=0,i=u.fileNumLimit>>0,r=!0;if(i){n.on("beforeFileQueued",function(n){return t>=i&&r&&(r=!1,this.trigger("error","Q_EXCEED_NUM_LIMIT",i,n),setTimeout(function(){r=!0},1)),t>=i?!1:!0});n.on("fileQueued",function(){t++});n.on("fileDequeued",function(){t--});n.on("uploadFinished",function(){t=0})}}),r.addValidator("fileSizeLimit",function(){var n=this,u=n.options,t=0,i=u.fileSizeLimit>>0,r=!0;if(i){n.on("beforeFileQueued",function(n){var u=t+n.size>i;return u&&r&&(r=!1,this.trigger("error","Q_EXCEED_SIZE_LIMIT",i,n),setTimeout(function(){r=!0},1)),u?!1:!0});n.on("fileQueued",function(n){t+=n.size});n.on("fileDequeued",function(n){t-=n.size});n.on("uploadFinished",function(){t=0})}}),r.addValidator("fileSingleSizeLimit",function(){var n=this,r=n.options,t=r.fileSingleSizeLimit;if(t)n.on("beforeFileQueued",function(n){if(n.size>t)return n.setStatus(i.Status.INVALID,"exceed_size"),this.trigger("error","F_EXCEED_SIZE",n),!1})}),r.addValidator("duplicate",function(){function r(n){for(var t=0,i=0,u=n.length,r;i<u;i++)r=n.charCodeAt(i),t=r+(t<<6)+(t<<16)-t;return t}var n=this,i=n.options,t={};if(!i.duplicate){n.on("beforeFileQueued",function(n){var i=n.__hash||(n.__hash=r(n.name+n.size+n.lastModifiedDate));if(t[i])return this.trigger("error","F_DUPLICATE",n),!1});n.on("fileQueued",function(n){var i=n.__hash;i&&(t[i]=!0)});n.on("fileDequeued",function(n){var i=n.__hash;i&&delete t[i]})}}),r}),t("runtime/compbase",[],function(){function n(n,t){this.owner=n;this.options=n.options;this.getRuntime=function(){return t};this.getRuid=function(){return t.uid};this.trigger=function(){return n.trigger.apply(n,arguments)}}return n}),t("runtime/flash/runtime",["base","runtime/runtime","runtime/compbase"],function(t,i,r){function s(){var n;try{n=navigator.plugins["Shockwave Flash"];n=n.description}catch(t){try{n=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(i){n="0.0"}}return n=n.match(/\d+/g),parseFloat(n[0]+"."+n[1],10)}function u(){function c(n,t){var i=n.type||n,f,u;f=i.split("::");u=f[0];i=f[1];i==="Ready"&&u===r.uid?r.trigger("ready"):e[u]&&e[u].trigger(i.toLowerCase(),n,t)}var u={},e={},s=this.destory,r=this,h=t.guid("webuploader_");i.apply(r,arguments);r.type=o;r.exec=function(n,i){var o=this,s=o.uid,c=t.slice(arguments,2),h;return(e[s]=o,f[n]&&(u[s]||(u[s]=new f[n](o,r)),h=u[s],h[i]))?h[i].apply(h,c):r.flashExec.apply(o,arguments)};n[h]=function(){var n=arguments;setTimeout(function(){c.apply(null,n)},1)};this.jsreciver=h;this.destory=function(){return s&&s.apply(this,arguments)};this.flashExec=function(n,i){var u=r.getFlash(),f=t.slice(arguments,2);return u.exec(this.uid,n,i,f)}}var e=t.$,o="flash",f={};return t.inherits(i,{constructor:u,init:function(){var i=this.getContainer(),r=this.options,n;i.css({position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});n='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+r.swf+'" ';t.browser.ie&&(n+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" ');n+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+r.swf+'" /><param name="flashvars" value="uid='+this.uid+"&jsreciver="+this.jsreciver+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /><\/object>';i.html(n)},getFlash:function(){return this._flash?this._flash:(this._flash=e("#"+this.uid).get(0),this._flash)}}),u.register=function(n,i){return f[n]=t.inherits(r,e.extend({flashExec:function(){var n=this.owner,t=this.getRuntime();return t.flashExec.apply(n,arguments)}},i))},s()>=11.4&&i.addRuntime(o,u),u}),t("runtime/flash/filepicker",["base","runtime/flash/runtime"],function(n,t){var i=n.$;return t.register("FilePicker",{init:function(n){for(var t=i.extend({},n),u=t.accept&&t.accept.length,r=0;r<u;r++)t.accept[r].title||(t.accept[r].title="Files");delete t.button;delete t.container;this.flashExec("FilePicker","init",t)},destroy:function(){}})}),t("runtime/flash/image",["runtime/flash/runtime"],function(n){return n.register("Image",{loadFromBlob:function(n){var t=this.owner;t.info()&&this.flashExec("Image","info",t.info());t.meta()&&this.flashExec("Image","meta",t.meta());this.flashExec("Image","loadFromBlob",n.uid)}})}),t("runtime/flash/transport",["base","runtime/flash/runtime","runtime/client"],function(n,t,i){var r=n.$;return t.register("Transport",{init:function(){this._status=0;this._response=null;this._responseJson=null},send:function(){var i=this.owner,n=this.options,t=this._initAjax(),u=i._blob,f=n.server,e;t.connectRuntime(u.ruid);n.sendAsBinary?(f+=(/\?/.test(f)?"&":"?")+r.param(i._formData),e=u.uid):(r.each(i._formData,function(n,i){t.exec("append",n,i)}),t.exec("appendBlob",n.fileVal,u.uid,n.filename||i._formData.name||""));this._setRequestHeader(t,n.headers);t.exec("send",{method:n.method,url:f},e)},getStatus:function(){return this._status},getResponse:function(){return this._response},getResponseAsJson:function(){return this._responseJson},abort:function(){var n=this._xhr;n&&(n.exec("abort"),n.destroy(),this._xhr=n=null)},destroy:function(){this.abort()},_initAjax:function(){var t=this,n=new i("XMLHttpRequest");n.on("uploadprogress progress",function(n){return t.trigger("progress",n.loaded/n.total)});n.on("load",function(){var i=n.exec("getStatus"),r="";return n.off(),t._xhr=null,i>=200&&i<300?(t._response=n.exec("getResponse"),t._responseJson=n.exec("getResponseAsJson")):i>=500&&i<600?(t._response=n.exec("getResponse"),t._responseJson=n.exec("getResponseAsJson"),r="server"):r="http",n.destroy(),n=null,r?t.trigger("error",r):t.trigger("load")});n.on("error",function(){n.off();t._xhr=null;t.trigger("error","http")});return t._xhr=n,n},_setRequestHeader:function(n,t){r.each(t,function(t,i){n.exec("setRequestHeader",t,i)})}})}),t("preset/flashonly",["base","widgets/filepicker","widgets/image","widgets/queue","widgets/runtime","widgets/upload","widgets/validator","runtime/flash/filepicker","runtime/flash/image","runtime/flash/transport"],function(n){return n}),t("webuploader",["preset/flashonly"],function(n){return n}),i("webuploader")});
//# sourceMappingURL=webuploader.flashonly.min.js.map
